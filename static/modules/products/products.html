<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - STEL Shop</title>
    <!-- Anti-cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- CSS con timestamp para evitar cache -->
    <link rel="stylesheet" href="products.css?t=<?php echo time(); ?>">
</head>
<body>
    <!-- Overlay de carga -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-wrapper">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando productos...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üì¶ M√≥dulo de Productos</h1>
            <p>Gesti√≥n y selecci√≥n de productos desde MySQL</p>
        </header>

        <div class="main-content">
            <!-- Panel de Conexi√≥n a Base de Datos -->
            <section class="database-section">
                <h2>üóÑÔ∏è Base de Datos MySQL</h2>
                <div class="db-info">
                    <div class="db-status">
                        <span class="status-indicator" id="db-status-indicator"></span>
                        <span id="db-status-text">Desconectado</span>
                    </div>
                    <div class="db-details">
                        <span id="db-info">Sin informaci√≥n</span>
                    </div>
                    <button id="connect-db" onclick="connectDatabase()" class="btn btn-primary">
                        üîå Conectar
                    </button>
                    <button onclick="refreshProducts()" class="btn btn-secondary" disabled>
                        üîÑ Actualizar
                    </button>
                </div>
            </section>

            <!-- Panel de Estad√≠sticas -->
            <section class="stats-section">
                <h2>üìä Estad√≠sticas</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-products">0</h3>
                        <p>Total Productos</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="filtered-products">0</h3>
                        <p>Filtrados</p>
                    </div>
                    <div class="stat-card selected">
                        <h3 id="selected-products">0</h3>
                        <p>Seleccionados</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-value">$0</h3>
                        <p>Valor Total</p>
                    </div>
                </div>
            </section>

            <!-- Panel de Filtros -->
            <section class="filters-section">
                <div class="section-header">
                    <h2>üîç Filtros</h2>
                    <div class="filter-actions">
                        <button onclick="toggleAdvancedFilters()" class="btn btn-small">
                            ‚öôÔ∏è Avanzados
                        </button>
                        <button onclick="clearFilters()" class="btn btn-small">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>

                <!-- B√∫squeda r√°pida -->
                <div class="search-bar">
                    <input type="text" id="quick-search" placeholder="Buscar por SKU, descripci√≥n, modelo... (soporta b√∫squeda avanzada: familia:generadores stock:>10)">
                    <button onclick="quickSearch()" class="btn btn-primary">üîç Buscar</button>
                </div>

                <!-- Filtros b√°sicos -->
                <div class="basic-filters">
                    <div class="filter-group">
                        <label>Familia:</label>
                        <select id="filter-familia" onchange="applyFilters()" title="Filtrar por familia">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Marca:</label>
                        <select id="filter-marca" onchange="applyFilters()" title="Filtrar por marca">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Stock:</label>
                        <select id="filter-stock" onchange="applyFilters()" title="Filtrar por stock">
                            <option value="">Todos</option>
                            <option value="con_stock">Con Stock</option>
                            <option value="sin_stock">Sin Stock</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Precio:</label>
                        <input type="number" id="filter-precio-min" placeholder="Min" onchange="applyFilters()">
                        <input type="number" id="filter-precio-max" placeholder="Max" onchange="applyFilters()">
                    </div>
                </div>

                <!-- Filtros avanzados (ocultos por defecto) -->
                <div id="advanced-filters" class="advanced-filters" style="display: none;">
                    <div class="filter-group">
                        <label>Potencia (KVA):</label>
                        <input type="number" id="filter-potencia-min" placeholder="Min">
                        <input type="number" id="filter-potencia-max" placeholder="Max">
                    </div>
                    <div class="filter-group">
                        <label>Caracter√≠sticas:</label>
                        <label class="checkbox">
                            <input type="checkbox" id="filter-cabina"> Con Cabina
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" id="filter-tta"> Con TTA
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>Combustible:</label>
                        <select id="filter-combustible" title="Filtrar por combustible">
                            <option value="">Todos</option>
                            <option value="diesel">Diesel</option>
                            <option value="nafta">Nafta</option>
                            <option value="gas">Gas</option>
                        </select>
                    </div>
                </div>

                <!-- Filtros guardados -->
                <div class="saved-filters">
                    <label>Filtros guardados:</label>
                    <select id="saved-filters" onchange="loadSavedFilter()" title="Cargar filtro guardado">
                        <option value="">Seleccionar...</option>
                        <optgroup label="Predefinidos">
                            <option value="preset:en_stock">En Stock</option>
                            <option value="preset:sin_stock">Sin Stock</option>
                            <option value="preset:generadores_diesel">Generadores Diesel</option>
                            <option value="preset:alta_potencia">Alta Potencia (>100KVA)</option>
                        </optgroup>
                        <optgroup label="Personalizados" id="custom-filters-group">
                        </optgroup>
                    </select>
                    <button onclick="saveCurrentFilter()" class="btn btn-small">üíæ Guardar</button>
                </div>

                <!-- Resumen de filtros activos -->
                <div id="filter-summary" class="filter-summary" style="display: none;">
                    <span id="filter-summary-text"></span>
                </div>
            </section>

            <!-- Panel de Productos -->
            <section class="products-section">
                <div class="section-header">
                    <h2>üìã Lista de Productos</h2>
                    <div class="table-actions">
                        <button onclick="selectAll(true)" class="btn btn-small">‚úÖ Todos</button>
                        <button onclick="selectAll(false)" class="btn btn-small">‚ùå Ninguno</button>
                        <button onclick="invertSelection()" class="btn btn-small">üîÑ Invertir</button>
                        <button onclick="selectByFilter()" class="btn btn-small">üéØ Por Filtro</button>
                    </div>
                </div>

                <!-- Tabla de productos -->
                <div class="table-container">
                    <table id="products-table" class="products-table">
                        <thead>
                            <tr>
                                <th class="checkbox-column">
                                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()">
                                </th>
                                <th onclick="sortTable('SKU')">SKU <span class="sort-indicator"></span></th>
                                <th onclick="sortTable('Descripci√≥n')">Descripci√≥n <span class="sort-indicator"></span></th>
                                <th onclick="sortTable('Marca')">Marca <span class="sort-indicator"></span></th>
                                <th onclick="sortTable('Familia')">Familia <span class="sort-indicator"></span></th>
                                <th onclick="sortTable('Stock')" class="numeric">Stock <span class="sort-indicator"></span></th>
                                <th onclick="sortTable('Precio_USD_con_IVA')" class="numeric">Precio USD <span class="sort-indicator"></span></th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <!-- Productos se cargan din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginaci√≥n -->
                <div class="pagination">
                    <button onclick="previousPage()" class="btn btn-small" disabled>‚¨ÖÔ∏è Anterior</button>
                    <span id="page-info">P√°gina 1 de 1</span>
                    <button onclick="nextPage()" class="btn btn-small" disabled>Siguiente ‚û°Ô∏è</button>
                    <select id="items-per-page" onchange="changePageSize()">
                        <option value="25">25 por p√°gina</option>
                        <option value="50">50 por p√°gina</option>
                        <option value="100">100 por p√°gina</option>
                        <option value="all">Todos</option>
                    </select>
                </div>
            </section>

            <!-- Panel de Acciones -->
            <section class="actions-section">
                <h2>üöÄ Acciones</h2>
                <div class="actions-grid">
                    <div class="action-group">
                        <h3>Selecci√≥n</h3>
                        <button onclick="saveSelection()" class="btn btn-secondary">
                            üíæ Guardar Selecci√≥n
                        </button>
                        <button onclick="loadSelection()" class="btn btn-secondary">
                            üìÇ Cargar Selecci√≥n
                        </button>
                        <button onclick="exportSelection()" class="btn btn-secondary">
                            üì§ Exportar
                        </button>
                    </div>
                    
                    <div class="action-group">
                        <h3>Procesamiento</h3>
                        <button onclick="processSelected()" class="btn btn-success" id="process-button" disabled>
                            ‚ö° Procesar Seleccionados
                        </button>
                        <button onclick="previewSelected()" class="btn btn-primary">
                            üëÅÔ∏è Vista Previa
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Modal de Detalles del Producto -->
        <div id="product-details-modal" class="modal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2>üìã Detalles del Producto</h2>
                    <span class="close" onclick="closeModal('product-details-modal')">&times;</span>
                </div>
                <div class="modal-body" id="product-details-content">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>

        <!-- Modal de Vista Previa -->
        <div id="preview-modal" class="modal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2>üëÅÔ∏è Vista Previa de Selecci√≥n</h2>
                    <span class="close" onclick="closeModal('preview-modal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="preview-summary"></div>
                    <div id="preview-list"></div>
                    <div class="modal-actions">
                        <button onclick="confirmProcessing()" class="btn btn-success">
                            ‚úÖ Confirmar y Procesar
                        </button>
                        <button onclick="closeModal('preview-modal')" class="btn btn-secondary">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Guardar Filtro -->
        <div id="save-filter-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üíæ Guardar Filtro</h2>
                    <span class="close" onclick="closeModal('save-filter-modal')">&times;</span>
                </div>
                <div class="modal-body">
                    <label>Nombre del filtro:</label>
                    <input type="text" id="filter-name" placeholder="Ej: Generadores en stock" title="Nombre del filtro">
                    <div class="modal-actions">
                        <button onclick="confirmSaveFilter()" class="btn btn-primary">Guardar</button>
                        <button onclick="closeModal('save-filter-modal')" class="btn btn-secondary">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript con timestamp -->
<script>
    // Forzar recarga si detecta versi√≥n antigua
    const CURRENT_VERSION = new Date().getTime();
    window.moduleVersion = CURRENT_VERSION;
</script>
<script src="products.js?t=<?php echo time(); ?>"></script>
</body>
</html>
